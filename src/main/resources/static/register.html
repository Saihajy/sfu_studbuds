<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UhTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SFU StudyBuds Registration</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 2rem auto; padding: 0 1rem; }
        .form-section { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; border-radius: 8px; }
        .form-group { margin-bottom: 10px; }
        label { display: inline-block; width: 100px; font-weight: bold; }
        input, select { padding: 5px; width: 200px; }
        button { padding: 10px 20px; background-color: #a6192e; color: white; border: none; cursor: pointer; }
        button:hover { background-color: #8a1526; }
        .availability-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; }
        .availability-grid label { width: auto; font-weight: normal; }
    </style>
</head>
<body>

    <h1>SFU StudyBuds Signup</h1>

    <form id="signupForm">
        
        <div class="form-section">
            <h3>Personal Information</h3>
            <div class="form-group">
                <label>Name:</label>
                <input type="text" id="name" required>
            </div>
            <div class="form-group">
                <label>Email:</label>
                <input type="email" id="email" placeholder="SFU Email" required>
            </div>
            <div class="form-group">
                <label>Password:</label>
                <input type="password" id="password" required>
            </div>
            <div class="form-group">
                <label>Age:</label>
                <input type="number" id="age" min="10" max="90" required>
            </div>
            <div class="form-group">
                <label>Gender:</label>
                <select id="gender">
                    <option value="M">Male</option>
                    <option value="F">Female</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label>Phone:</label>
                <input type="text" id="phone">
            </div>
        </div>

        <div class="form-section">
            <h3>School Information</h3>
            <div class="form-group">
                <label>Program:</label>
                <input type="text" id="program" placeholder="e.g. Computer Science">
            </div>
            <div class="form-group">
                <label>Year:</label>
                <input type="number" id="studentYear" min="1" max="6" required>
            </div>

            <h4>Current Course</h4>
            <div style="background: #f0f0f0; padding: 10px;">
                <input type="text" id="courseDept" placeholder="Dept (e.g. cmpt)" style="width: 80px;">
                <input type="text" id="courseNum" placeholder="Num (e.g. 120)" style="width: 80px;">
                <select id="courseTerm" style="width: 90px;">
                    <option value="spring">Spring</option>
                    <option value="summer">Summer</option>
                    <option value="fall">Fall</option>
                </select>
                <input type="number" id="courseYear" value="2025" style="width: 70px;">
            </div>

            <h4>Study Availability</h4>
            <div class="availability-grid">
                <label><input type="checkbox" id="Mon"> Monday</label>
                <label><input type="checkbox" id="Tue"> Tuesday</label>
                <label><input type="checkbox" id="Wed"> Wednesday</label>
                <label><input type="checkbox" id="Thu"> Thursday</label>
                <label><input type="checkbox" id="Fri"> Friday</label>
                <label><input type="checkbox" id="Sat"> Saturday</label>
                <label><input type="checkbox" id="Sun"> Sunday</label>
            </div>
        </div>

        <button type="submit">Register</button>
        <button type="button" id="backBtn">Back to Main page</button>
        
    </form>
    


    <script>

        document.getElementById("backBtn").addEventListener("click", () => {
            window.location.href = "/";
        });

        document.getElementById('signupForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const personal = {
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                password: document.getElementById('password').value, 
                age: Number(document.getElementById('age').value),
                gender: document.getElementById('gender').value,
                phone: document.getElementById('phone').value
            };

            const days = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
            const availability = {};
            const dayMap = { 
                "Mon": "Monday", "Tue": "Tuesday", "Wed": "Wednesday", 
                "Thu": "Thursday", "Fri": "Friday", "Sat": "Saturday", "Sun": "Sunday" 
            };
            
            days.forEach(d => {
                // If checked, true. If not, false.
                availability[dayMap[d]] = document.getElementById(d).checked;
            });

            // SFU API requires lowercase dept
            const courses = [{
                dept: document.getElementById('courseDept').value.toLowerCase(),
                number: document.getElementById('courseNum').value,
                term: document.getElementById('courseTerm').value,
                year: document.getElementById('courseYear').value
            }];

            const payload = {
                personal: personal,
                school: {
                    schoolName: "SFU",
                    program: document.getElementById('program').value,
                    studentYear: Number(document.getElementById('studentYear').value),
                    courses: courses,
                    studyAvailability: availability
                }
            };

            console.log("Sending payload:", payload);

            try {
                const response = await fetch('http://localhost:3000/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json(); 

                if (response.ok) {
                    alert("Success! User ID: " + result._id);
                } else {
                    const errMsg = result.error || result.message || JSON.stringify(result);
                    alert("Error: " + errMsg);
                }
            } catch (err) {
                console.error(err);
                alert("Network Error: Ensure server is running on port 3000");
            }
        });

        if (res.ok) {
            const email = document.getElementById("email").value;
            
            localStorage.setItem("currentUserEmail", email);

            alert("Account created!");
            window.location.href = "group.html"; 
        }
    </script>
</body>
</html>